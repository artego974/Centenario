<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Ocupa√ß√£o de Leitos - Hist√≥rico e Previs√£o</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Gemini IA (Google Generative AI) -->
  <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai/dist/browser.umd.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f3f3;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }

    #graficoContainer {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 900px;
    }

    h2 {
      margin-bottom: 0.5rem;
      font-size: 24px;
      color: #333;
      text-align: left;
    }

    #statusIa {
      font-size: 14px;
      color: #555;
      margin-bottom: 1rem;
    }

    canvas {
      display: block;
      width: 100% !important;
      height: 450px !important;
    }
  </style>
</head>
<body>

  <div id="graficoContainer">
    <h2>Ocupa√ß√£o de Leitos - Hist√≥rico e Previs√£o</h2>
    <div id="statusIa">Carregando dados...</div>
    <canvas id="grafico"></canvas>
  </div>

  <script>
    // -------------------------------------
    // üîë CONFIG GEMINI (IA)
    // -------------------------------------
    // üëâ TROCA ESSA STRING PELA TUA API KEY REAL
    const apiKey = "SUA_API_KEY_AQUI";

    let genAI = null;
    if (window.GoogleGenerativeAI && apiKey && apiKey !== "SUA_API_KEY_AQUI") {
      genAI = new GoogleGenerativeAI.GoogleGenerativeAI(apiKey);
    }

    const statusIaEl = document.getElementById("statusIa");

    // -------------------------------------
    // üìä CONTROLE DO GR√ÅFICO
    // -------------------------------------
    let grafico = null;

    function criarGrafico(labels, dadosHistorico, dadosPrevSimples, dadosPrevIA) {
      const canvas = document.getElementById("grafico");

      if (grafico) grafico.destroy();

      const datasets = [
        {
          label: "Hist√≥rico de Ocupa√ß√£o",
          data: dadosHistorico,
          borderColor: "rgba(0, 120, 215, 1)",
          backgroundColor: "rgba(0, 120, 215, 0.2)",
          borderWidth: 3,
          tension: 0.3,
          pointRadius: 4
        },
        {
          label: "Previs√£o Simples",
          data: dadosPrevSimples,
          borderColor: "rgba(0, 200, 80, 1)",
          backgroundColor: "rgba(0, 200, 80, 0.15)",
          borderWidth: 2,
          borderDash: [6, 4],
          tension: 0.3,
          pointRadius: 3
        }
      ];

      // S√≥ adiciona dataset da IA se existir
      if (dadosPrevIA) {
        datasets.push({
          label: "Previs√£o IA (Gemini)",
          data: dadosPrevIA,
          borderColor: "rgba(200, 0, 80, 1)",
          backgroundColor: "rgba(200, 0, 80, 0.15)",
          borderWidth: 2,
          tension: 0.3,
          pointRadius: 3
        });
      }

      grafico = new Chart(canvas, {
        type: "line",
        data: {
          labels,
          datasets
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    // -------------------------------------
    // 1Ô∏è‚É£ PEGAR DADOS DO LOCALSTORAGE (OU FICT√çCIOS)
    // -------------------------------------
    function obterDadosHistoricos() {
      let labels = JSON.parse(localStorage.getItem("ocupadosDatas"));
      let valores = JSON.parse(localStorage.getItem("ocupadosValores"));

      // Se n√£o tiver nada salvo, usa dados fict√≠cios
      if (!Array.isArray(labels) || !Array.isArray(valores) || labels.length === 0 || valores.length === 0) {
        labels = ["Dia -6", "Dia -5", "Dia -4", "Dia -3", "Dia -2", "Dia -1", "Dia 0"];
        valores = [12, 15, 18, 20, 22, 25, 27];
      }

      return { labels, valores };
    }

    // -------------------------------------
    // 2Ô∏è‚É£ PREVIS√ÉO SIMPLES (SEM IA) ‚Äì DO TEU SEGUNDO C√ìDIGO
    // -------------------------------------
    function calcularPrevisaoSimples(ultimoValor, qtdDias) {
      const previsoes = [];
      for (let i = 1; i <= qtdDias; i++) {
        // Regra bobinha s√≥ pra ter algo: soma 2 a cada dia
        previsoes.push(ultimoValor + i * 2);
      }
      return previsoes;
    }

    // -------------------------------------
    // 3Ô∏è‚É£ PREVIS√ÉO COM IA (GEMINI) ‚Äì DO TEU TERCEIRO C√ìDIGO
    // -------------------------------------
    async function gerarPrevisoesIA(valoresPassados, qtdDias) {
      if (!genAI) {
        statusIaEl.textContent = "IA n√£o configurada (adicione sua API key). Mostrando s√≥ previs√£o simples.";
        return null;
      }

      statusIaEl.textContent = "Gerando previs√£o com IA...";

      const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

      const prompt = `
Voc√™ √© uma IA especialista em an√°lise de ocupa√ß√£o hospitalar.

Valores de ocupa√ß√£o de leitos dos dias anteriores (em ordem cronol√≥gica):
${valoresPassados.join(", ")}

Gere previs√µes num√©ricas para os pr√≥ximos ${qtdDias} dias.
Responda EXATAMENTE neste formato (um por linha):

Dia 1: n√∫mero
Dia 2: n√∫mero
Dia 3: n√∫mero
Dia 4: n√∫mero
Dia 5: n√∫mero
Dia 6: n√∫mero
Dia 7: n√∫mero
      `;

      try {
        const result = await model.generateContent(prompt);
        const texto = result.response.text();
        console.log("Resposta da IA:", texto);

        const linhas = texto.split("\n").filter(l => l.includes(":"));

        const valoresPrevisao = [];

        linhas.forEach(linha => {
          const partes = linha.split(":");
          if (partes.length < 2) return;
          const num = Number(String(partes[1]).trim().replace(",", "."));
          if (!isNaN(num)) {
            valoresPrevisao.push(num);
          }
        });

        if (valoresPrevisao.length === 0) {
          statusIaEl.textContent = "IA respondeu em formato inesperado. Usando s√≥ previs√£o simples.";
          return null;
        }

        statusIaEl.textContent = "Previs√£o com IA gerada com sucesso.";
        return valoresPrevisao;
      } catch (err) {
        console.error("Erro com IA:", err);
        statusIaEl.textContent = "Erro ao chamar a IA. Usando s√≥ previs√£o simples.";
        return null;
      }
    }

    // -------------------------------------
    // 4Ô∏è‚É£ INICIALIZA TUDO (JUNTA OS 3 C√ìDIGOS)
    // -------------------------------------
    async function iniciar() {
      const { labels, valores } = obterDadosHistoricos();
      const qtdDiasPrevisao = 7;

      // Previs√£o simples
      const ultimo = valores[valores.length - 1];
      const previsaoSimples = calcularPrevisaoSimples(ultimo, qtdDiasPrevisao);

      // Labels dos dias futuros
      const labelsFuturos = [];
      for (let i = 1; i <= qtdDiasPrevisao; i++) {
        labelsFuturos.push(`Dia +${i}`);
      }

      // Labels finais (hist√≥rico + previs√£o)
      const labelsFinais = [...labels, ...labelsFuturos];

      // Dados para o gr√°fico (todos com o MESMO tamanho do labelsFinais)
      const dadosHistorico = [...valores, ...Array(qtdDiasPrevisao).fill(null)];
      const dadosPrevSimples = [...Array(valores.length).fill(null), ...previsaoSimples];

      // Previs√£o IA
      const previsaoIA = await gerarPrevisoesIA(valores, qtdDiasPrevisao);
      const dadosPrevIA = previsaoIA
        ? [...Array(valores.length).fill(null), ...previsaoIA]
        : null;

      criarGrafico(labelsFinais, dadosHistorico, dadosPrevSimples, dadosPrevIA);
    }

    window.addEventListener("load", iniciar);
  </script>
</body>
</html>
